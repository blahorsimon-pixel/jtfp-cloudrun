<view class="container">
  <view class="loading" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view class="error" wx:elif="{{error}}">
    <text>{{error}}</text>
    <button class="btn-retry" bindtap="loadDetail">é‡è¯•</button>
  </view>

  <view wx:else>
    <image class="cover" src="{{product.cover_url}}" mode="aspectFill" />

    <view class="card">
      <text class="title">{{product.title}}</text>
      <view class="row price-row">
        <text class="price-symbol">Â¥</text>
        <text class="price-value">{{displayPriceCent / 100}}</text>
        <text class="tag tag-welfare" wx:if="{{product.is_welfare == 1}}">ç¦åˆ©</text>
      </view>
    </view>

    <view class="card" wx:if="{{skus.length > 0 && product.is_welfare != 1}}">
      <text class="section-title">é€‰æ‹©è§„æ ¼</text>
      <view class="sku-list">
        <view
          class="sku-item {{selectedSkuId == item.id ? 'active' : ''}}"
          wx:for="{{skus}}"
          wx:key="id"
          data-id="{{item.id}}"
          bindtap="selectSku"
        >
          <text class="sku-text">{{item.sku_title}}</text>
        </view>
      </view>
    </view>

    <!-- ç¦åˆ©ç è¾“å…¥åŒºåŸŸï¼ˆä»…ç¦åˆ©å•†å“æ˜¾ç¤ºï¼‰ -->
    <view class="card welfare-section" wx:if="{{product.is_welfare == 1}}">
      <text class="section-title welfare-title">ç¦åˆ©ç </text>
      <input
        class="welfare-input"
        type="number"
        maxlength="6"
        placeholder="è¯·è¾“å…¥6ä½çº¯æ•°å­—ç¦åˆ©ç "
        value="{{welfareCode}}"
        bindinput="onWelfareCodeInput"
      />
      <!-- éªŒè¯ç»“æœ -->
      <view class="welfare-result" wx:if="{{welfareChecked}}">
        <!-- éªŒè¯æˆåŠŸ -->
        <view class="welfare-ok-box" wx:if="{{welfareValid}}">
          <text class="welfare-price">åŒ¹é…é‡‘é¢ï¼šÂ¥{{welfarePriceCent / 100}}</text>
          <view class="welfare-usage-hint" wx:if="{{welfareMaxUsage > 1}}">
            <text class="fire-icon">ğŸ”¥</text>
            <text>è¯¥ç¦åˆ©ç å¯ä½¿ç”¨ {{welfareMaxUsage}} æ¬¡ï¼Œå‰©ä½™ {{welfareRemainingUsage}} æ¬¡</text>
          </view>
          <view class="welfare-note-box" wx:if="{{welfareNote}}">
            <text class="note-label">å¤‡æ³¨ï¼š</text>
            <text>{{welfareNote}}</text>
          </view>
        </view>
        <!-- éªŒè¯å¤±è´¥ -->
        <view class="welfare-bad-box" wx:else>
          <text class="warning-icon">âš ï¸</text>
          <text>{{welfareError}}</text>
        </view>
      </view>
    </view>

    <view class="card" wx:if="{{product.is_welfare != 1}}">
      <text class="section-title">æ•°é‡</text>
      <view class="qty">
        <button class="qty-btn" bindtap="decQty">-</button>
        <text class="qty-value">{{qty}}</text>
        <button class="qty-btn" bindtap="incQty">+</button>
      </view>
    </view>

    <view class="card" wx:if="{{product.description}}">
      <text class="section-title">å•†å“è¯´æ˜</text>
      <view class="desc">
        <rich-text nodes="{{descNodes}}" />
      </view>
    </view>

    <view class="footer">
      <button class="btn btn-ghost" bindtap="goCart">è´­ç‰©è½¦</button>
      <button class="btn btn-primary" bindtap="addToCart" wx:if="{{product.is_welfare != 1}}">åŠ å…¥è´­ç‰©è½¦</button>
      <button 
        class="btn btn-buy {{product.is_welfare == 1 && !welfareValid ? 'btn-disabled' : ''}}" 
        bindtap="buyNow"
        disabled="{{product.is_welfare == 1 && !welfareValid}}"
      >ç«‹å³è´­ä¹°</button>
    </view>
  </view>

  <!-- å®¢æœæ‚¬æµ®æŒ‰é’® -->
  <kefu-float></kefu-float>
</view>
