openapi: 3.0.3
info:
  title: H5 Mall Redeem & Freight Pay API
  version: 1.0.0
  description: |
    积分兑换下单（商品仅用积分支付），运费单独走微信支付。
    - 兑换订单不发放积分；已发货退货不退运费。
    - 支持“每人每日限兑 N 件”。
servers:
  - url: https://api.example.com
security:
  - BearerAuth: []
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      schema: { type: string, maxLength: 128 }
      description: 幂等键，重要写操作必须携带
  schemas:
    Error:
      type: object
      required: [code, message, requestId]
      properties:
        code:
          $ref: '#/components/schemas/ErrorCode'
        message:
          type: string
        requestId:
          type: string
    ErrorCode:
      type: string
      enum:
        - INVALID_PARAMS
        - UNAUTHORIZED
        - FORBIDDEN
        - NOT_FOUND
        - RATE_LIMITED
        - DUPLICATE_REQUEST
        - INTERNAL_ERROR
        - INSUFFICIENT_POINTS
        - OUT_OF_STOCK
        - SKU_OFFLINE
        - ADDRESS_INVALID
        - PREPAY_FAILED
        - PAYMENT_FAILED
        - ORDER_STATE_CONFLICT
        - ORDER_NOT_FOUND
    OrderStatus:
      type: string
      enum:
        - PENDING_FREIGHT
        - WAIT_SHIP
        - SHIPPED
        - DELIVERED
        - COMPLETED
        - CLOSED_UNPAID
        - CANCELLED
        - RETURN_APPLY
        - RETURN_APPROVED
        - RETURN_REJECTED
        - RETURN_IN_TRANSIT
        - RETURN_RECEIVED
        - RETURN_REFUNDING
        - RETURN_COMPLETED
    PaymentStatus:
      type: string
      enum: [INIT, PENDING, SUCCESS, REFUNDING, REFUNDED, CLOSED, FAIL]
    ShippingQuoteResponse:
      type: object
      required: [freightAmountCent, expireAt]
      properties:
        freightAmountCent: { type: integer, format: int64 }
        expireAt: { type: string, format: date-time }
        carrierOptions:
          type: array
          items:
            type: object
            properties:
              carrierCode: { type: string }
              name: { type: string }
              amountCent: { type: integer }
    RedeemSku:
      type: object
      properties:
        id: { type: integer, format: int64 }
        spuId: { type: integer, format: int64 }
        skuTitle: { type: string }
        requiredPoints: { type: integer }
        stock: { type: integer }
        needAddress: { type: boolean }
        perUserLimit: { type: integer, nullable: true }
        dailyLimit: { type: integer, nullable: true }
        status: { type: integer }
    RedeemOrder:
      type: object
      required: [orderNo, status, pointsCost, freightAmountCent]
      properties:
        orderNo: { type: string }
        status: { $ref: '#/components/schemas/OrderStatus' }
        userId: { type: integer, format: int64 }
        skuId: { type: integer, format: int64 }
        skuTitle: { type: string }
        quantity: { type: integer, default: 1 }
        pointsCost: { type: integer, description: '本单消耗积分（整数）' }
        freightAmountCent: { type: integer }
        freightPayStatus: { $ref: '#/components/schemas/PaymentStatus' }
        freightOutTradeNo: { type: string, nullable: true }
        addressSnapshot:
          type: object
          additionalProperties: true
        createdAt: { type: string, format: date-time }
    RedeemOrderCreateRequest:
      type: object
      required: [skuId, addressId]
      properties:
        skuId: { type: integer, format: int64 }
        addressId: { type: integer, format: int64 }
    RedeemOrderCreateResponse:
      type: object
      required: [orderNo, status, freightAmountCent, requiredPoints, payRequired]
      properties:
        orderNo: { type: string }
        status:
          type: string
          enum: [PENDING_FREIGHT, WAIT_SHIP]
        freightAmountCent: { type: integer, format: int64 }
        requiredPoints: { type: integer, format: int64 }
        payRequired: { type: boolean }
    PayFreightRequest:
      type: object
      required: [payScene]
      properties:
        payScene:
          type: string
          enum: [JSAPI, MWEB]
        wxOpenId:
          type: string
          description: JSAPI 必填
        returnUrl:
          type: string
          description: MWEB 可选
    PayFreightResponseJSAPI:
      type: object
      properties:
        appId: { type: string }
        timeStamp: { type: string }
        nonceStr: { type: string }
        package: { type: string }
        signType: { type: string }
        paySign: { type: string }
    PayFreightResponseMWEB:
      type: object
      properties:
        mweb_url: { type: string }
    AddressUpdateRequest:
      type: object
      required: [addressId]
      properties:
        addressId: { type: integer, format: int64 }
    AddressUpdateResponse:
      type: object
      required: [orderNo, freightAmountCent, needNewPay]
      properties:
        orderNo: { type: string }
        freightAmountCent: { type: integer }
        needNewPay: { type: boolean }
    PointsSummary:
      type: object
      required: [available, owed, frozen, lifetimeEarned, lifetimeSpent, updatedAt]
      properties:
        available: { type: integer }
        owed: { type: integer }
        frozen: { type: integer }
        lifetimeEarned: { type: integer }
        lifetimeSpent: { type: integer }
        updatedAt: { type: string, format: date-time }
    PointsLedgerItem:
      type: object
      properties:
        id: { type: integer }
        change: { type: integer, description: '正负积分' }
        reason:
          type: string
          enum: [spend_redeem, redeem_rollback, offset_debt, earn_freeze, earn_release, refund_reverse, manual_adjust]
        refType: { type: string }
        refId: { type: string }
        rawX10: { type: integer }
        createdAt: { type: string, format: date-time }
    PaginatedPointsLedger:
      type: object
      properties:
        list:
          type: array
          items: { $ref: '#/components/schemas/PointsLedgerItem' }
        nextCursor: { type: string, nullable: true }
  responses:
    BadRequest:
      description: 参数错误
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
    Conflict:
      description: 状态冲突或重复请求
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
    NotFound:
      description: 资源不存在
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
paths:
  /shipping/quote:
    get:
      tags: [Shipping]
      summary: 计算运费
      parameters:
        - in: query
          name: skuId
          schema: { type: integer, format: int64 }
          required: true
        - in: query
          name: qty
          schema: { type: integer, default: 1, minimum: 1 }
        - in: query
          name: addressId
          schema: { type: integer, format: int64 }
          required: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ShippingQuoteResponse' }
        '400': { $ref: '#/components/responses/BadRequest' }
  /redeem/catalog:
    get:
      tags: [Catalog]
      summary: 兑换商品列表
      parameters:
        - in: query; name: page; schema: { type: integer, default: 1, minimum: 1 }
        - in: query; name: pageSize; schema: { type: integer, default: 20, maximum: 100 }
        - in: query; name: keyword; schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  list:
                    type: array
                    items: { $ref: '#/components/schemas/RedeemSku' }
                  total: { type: integer }
  /redeem/sku/{id}:
    get:
      tags: [Catalog]
      summary: 兑换商品详情
      parameters:
        - in: path; name: id; required: true; schema: { type: integer, format: int64 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/RedeemSku' }
        '404': { $ref: '#/components/responses/NotFound' }
  /redeem/orders:
    post:
      tags: [Redeem]
      summary: 创建兑换订单（扣积分+锁库存）
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RedeemOrderCreateRequest' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/RedeemOrderCreateResponse' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '409': { $ref: '#/components/responses/Conflict' }
  /redeem/orders/{orderNo}:
    get:
      tags: [Redeem]
      summary: 兑换订单详情
      parameters:
        - in: path; name: orderNo; required: true; schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/RedeemOrder' }
        '404': { $ref: '#/components/responses/NotFound' }
  /redeem/orders/{orderNo}/pay-freight:
    post:
      tags: [Redeem]
      summary: 发起运费预下单（仅运费）
      parameters:
        - in: path; name: orderNo; required: true; schema: { type:string }
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PayFreightRequest' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/PayFreightResponseJSAPI'
                  - $ref: '#/components/schemas/PayFreightResponseMWEB'
        '409': { $ref: '#/components/responses/Conflict' }
  /redeem/orders/{orderNo}/address:
    put:
      tags: [Redeem]
      summary: 支付前更新地址并重算运费
      parameters:
        - in: path; name: orderNo; required: true; schema: { type: string }
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AddressUpdateRequest' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AddressUpdateResponse' }
        '409': { $ref: '#/components/responses/Conflict' }
  /redeem/orders/{orderNo}/cancel:
    post:
      tags: [Redeem]
      summary: 取消兑换订单（未发货）
      parameters:
        - in: path; name: orderNo; required: true; schema: { type: string }
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  orderNo: { type: string }
                  status: { $ref: '#/components/schemas/OrderStatus' }
                  refundFreight: { type: string, enum: [NONE, APPLIED] }
        '409': { $ref: '#/components/responses/Conflict' }
  /payments/wechat/notify:
    post:
      tags: [Payment]
      summary: 微信支付回调（运费）
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { type: object, description: '微信v3回调体（resource解密后处理）' }
      responses:
        '200':
          description: OK
  /me/points:
    get:
      tags: [Points]
      summary: 我的积分汇总
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PointsSummary' }
  /me/points/ledger:
    get:
      tags: [Points]
      summary: 我的积分明细
      parameters:
        - in: query; name: cursor; schema: { type: string }
        - in: query; name: limit; schema: { type: integer, default: 20, maximum: 100 }
        - in: query; name: reason; schema:
            type: string
            enum: [spend_redeem, redeem_rollback, offset_debt, earn_freeze, earn_release, refund_reverse, manual_adjust]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PaginatedPointsLedger' }

